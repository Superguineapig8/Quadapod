#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver();

#define SERVO_MIN  130
#define SERVO_MAX  620


int angleToPWM(int angle) {
  angle = constrain(angle, 0, 180);
  return map(angle, 0, 180, SERVO_MIN, SERVO_MAX);
}

//Front right
constexpr int basePosFRF = 100;   //This is the base position pointing outwards
constexpr int basePosFRT = 0;
constexpr int basePosBLF = 100;  //This is the base position pointing outwards
constexpr int basePosBLT = 0;
constexpr int basePosBRF = 40; //This is the base position pointing outwards
constexpr int basePosBRT = 0;
constexpr int basePosFLF = 40; //This is the base position pointing outwards
constexpr int basePosFLT = 0;



constexpr int FRT = 0;
constexpr int FRF = 1;
constexpr int FLF = 2;
constexpr int FLT = 3;
constexpr int BLT = 4;
constexpr int BLF = 5;
constexpr int BRF = 6;
constexpr int BRT = 7;

//delay time
constexpr int delayTime = 100;

constexpr int raiseHeight = 60; 
constexpr int glideRaise = 15;


//movement distance
const int move = 30;

void setup() {
  Serial.begin(115200);
  pwm.begin();
  pwm.setPWMFreq(50);
  delay(100);
}

inline void baseState()
{

  pwm.setPWM(FRT,0, angleToPWM(basePosFRT));
  pwm.setPWM(FRF,0, angleToPWM(basePosFRF));
  pwm.setPWM(FLT,0, angleToPWM(basePosFLT));
  pwm.setPWM(FLF,0, angleToPWM(basePosFLF));
  pwm.setPWM(BRT,0, angleToPWM(basePosBRT));
  pwm.setPWM(BRF,0, angleToPWM(basePosBRF));
  pwm.setPWM(BLT,0, angleToPWM(basePosBLT));
  pwm.setPWM(BLF,0, angleToPWM(basePosBLF));
  delay(delayTime);
}

void Fsequence1()   //Front Right and Back Left Motor move forward
{
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT + raiseHeight));  //Move Front Left Leg
    delay(delayTime);
    pwm.setPWM(FRF, 0, angleToPWM(basePosFRF + move));
    delay(delayTime);
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT));
    delay(delayTime);

    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT + raiseHeight)); // Move Back Right Leg
    delay(delayTime);
    pwm.setPWM(BLF, 0, angleToPWM(basePosBLF - move));
    delay(delayTime);
    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT));
    delay(delayTime);


    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT + glideRaise));  //Pick up the other two legs slightly
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT + glideRaise));
    delay(delayTime);

    pwm.setPWM(BLF, 0, angleToPWM(basePosBLF));  //Move the femurs to base position
    pwm.setPWM(FRF, 0, angleToPWM(basePosFRF));

    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT)); //Put the tibias back down of the other two legs 
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT));
    delay(delayTime);
}

void Fsequence2() //Front Left and Back Right Motor move forward
{
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT + raiseHeight));  //Move Front Left Leg
    delay(delayTime);
    pwm.setPWM(FLF, 0, angleToPWM(basePosFLF - move));
    delay(delayTime);
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT));
    delay(delayTime);

    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT + raiseHeight)); // Move Back Right Leg
    delay(delayTime);
    pwm.setPWM(BRF, 0, angleToPWM(basePosBRF + move));
    delay(delayTime);
    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT));
    delay(delayTime);


    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT + glideRaise));  //Pick up the other two legs slightly
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT + glideRaise));
    delay(delayTime);

    pwm.setPWM(BRF, 0, angleToPWM(basePosBRF)); //Move the femurs to base position
    pwm.setPWM(FLF, 0, angleToPWM(basePosFLF));

    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT)); //Put the tibias back down of the other two legs 
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT));
    delay(delayTime);
}

void forward()  //Move the front right and back left legs forward first, then the front left and back right legs 
{
  Fsequence1();
  Fsequence2();
}

void Bsequence1()   //Front Right and Back Left Motor move forward
{
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT + raiseHeight));  //Move Front Left Leg
    delay(delayTime);
    pwm.setPWM(FRF, 0, angleToPWM(basePosFRF - move));
    delay(delayTime);
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT));
    delay(delayTime);

    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT + raiseHeight)); // Move Back Right Leg
    delay(delayTime);
    pwm.setPWM(BLF, 0, angleToPWM(basePosBLF + move));
    delay(delayTime);
    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT));
    delay(delayTime);


    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT + glideRaise));  //Pick up the other two legs slightly
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT + glideRaise));
    delay(delayTime);

    pwm.setPWM(BLF, 0, angleToPWM(basePosBLF));  //Move the femurs to base position
    pwm.setPWM(FRF, 0, angleToPWM(basePosFRF));

    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT)); //Put the tibias back down of the other two legs 
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT));
    delay(delayTime);
}

void Bsequence2() //Front Left and Back Right Motor move forward
{
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT + raiseHeight));  //Move Front Left Leg
    delay(delayTime);
    pwm.setPWM(FLF, 0, angleToPWM(basePosFLF + move));
    delay(delayTime);
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT));
    delay(delayTime);

    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT + raiseHeight)); // Move Back Right Leg
    delay(delayTime);
    pwm.setPWM(BRF, 0, angleToPWM(basePosBRF - move));
    delay(delayTime);
    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT));
    delay(delayTime);


    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT + glideRaise));  //Pick up the other two legs slightly
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT + glideRaise));
    delay(delayTime);

    pwm.setPWM(BRF, 0, angleToPWM(basePosBRF)); //Move the femurs to base position
    pwm.setPWM(FLF, 0, angleToPWM(basePosFLF));

    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT)); //Put the tibias back down of the other two legs 
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT));
    delay(delayTime);
}

void backward()  //Move the front right and back left legs forward first, then the front left and back right legs 
{
  Bsequence1();
  Bsequence2();
}

void FrightSide() //Helper method to turn all femurs on the right forward
{
    //Move Front Right Leg first
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT + raiseHeight)); //Raise Front Right tibia 
    delay(delayTime);
    pwm.setPWM(FRF, 0, angleToPWM(basePosFRF - move)); //Move Front Right Femur forward
    delay(delayTime);
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT)); //Lower Front Right Tibia
    delay(delayTime);

    //Then move Back Right Leg
    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT + raiseHeight)); //Raise Back Right tibia 
    delay(delayTime);
    pwm.setPWM(BRF, 0, angleToPWM(basePosBRF - move)); //Move Back Right Femur forward
    delay(delayTime);
    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT)); //Lower Back Right Tibia
    delay(delayTime);
}

void FleftSide() //Helper method to turn all femurs on the left forward
{
    //Move Front Left Leg first
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT + raiseHeight)); //Raise Front Left tibia 
    delay(delayTime);
    pwm.setPWM(FLF, 0, angleToPWM(basePosFLF + move)); //Move Front Left Femur forward
    delay(delayTime);
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT)); //Lower Front Left Tibia
    delay(delayTime);

    //Then move Back Left Leg
    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT + raiseHeight)); //Raise Back Left tibia 
    delay(delayTime);
    pwm.setPWM(BLF, 0, angleToPWM(basePosBLF + move)); //Move Back Left Femur forward
    delay(delayTime);
    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT)); //Lower Back Left Tibia
    delay(delayTime);
}

void BrightSide() //Helper method to turn all femurs on the right backward
{
    //Move Front Right Leg first
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT + raiseHeight)); //Raise Front Right tibia 
    delay(delayTime);
    pwm.setPWM(FRF, 0, angleToPWM(basePosFRF + move)); //Move Front Right Femur backward
    delay(delayTime);
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT)); //Lower Front Right Tibia
    delay(delayTime);

    //Then move Back Right Leg
    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT + raiseHeight)); //Raise Back Right tibia 
    delay(delayTime);
    pwm.setPWM(BRF, 0, angleToPWM(basePosBRF + move)); //Move Back Right Femur backward
    delay(delayTime);
    pwm.setPWM(BRT, 0, angleToPWM(basePosBRT)); //Lower Back Right Tibia
    delay(delayTime);
}
void BleftSide() //Helper method to turn all femurs on the left backward
{
    //Move Front Left Leg first
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT + raiseHeight)); //Raise Front Left tibia 
    delay(delayTime);
    pwm.setPWM(FLF, 0, angleToPWM(basePosFLF - move)); //Move Front Left Femur backward
    delay(delayTime);
    pwm.setPWM(FLT, 0, angleToPWM(basePosFLT)); //Lower Front Left Tibia
    delay(delayTime);

    //Then move Back Left Leg
    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT + raiseHeight)); //Raise Back Left tibia 
    delay(delayTime);
    pwm.setPWM(BLF, 0, angleToPWM(basePosBLF - move)); //Move Back Left Femur backward
    delay(delayTime);
    pwm.setPWM(BLT, 0, angleToPWM(basePosBLT)); //Lower Back Left Tibia
    delay(delayTime);
}

void right()
{
  FrightSide(); 
  BleftSide();
  baseState();
}

void left()
{
  FleftSide(); 
  BrightSide();
  baseState();
}



void Lsequence1()   //Front Right and Back Left Motor move forward
{
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT + raiseHeight));  //Move Front Left Leg
    delay(delayTime);
    pwm.setPWM(FRF, 0, angleToPWM(basePosFRF + move));
    delay(delayTime);
    pwm.setPWM(FRT, 0, angleToPWM(basePosFRT));
    delay(delayTime);
}


void loop()
{
  if (Serial.available() > 0)
  {
      char cmd = Serial.read();
      if (cmd == 'w') forward();
      if (cmd == 's') backward();
      if (cmd == 'a') left();
      if (cmd == 'd') right();
      if (cmd == 'z') baseState();
  }
}
